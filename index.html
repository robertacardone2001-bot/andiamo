<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Per Margherita ‚Äî La canzone di Achille</title>
  <meta name="description" content="La canzone di Achille, Madeline Miller." />
  <meta property="og:title" content="Per Margherita ‚Äî La canzone di Achille" />
  <meta property="og:description" content="Audiolibro capitoli personalizzati" />
  <meta property="og:type" content="website" />

  <!-- Icona -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%E2%9D%A4%EF%B8%8F%3C/text%3E%3C/svg%3E">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Stili -->
  <style>
    :root{
      --bg1:#f4f4eb;
      --bg2:#e9eddb;
      --card:#ffffff;
      --ink:#2f3120;
      --muted:#6b705c;
      --accent:#6b8e23;
      --accent-2:#a4b97f;
    }
    body{
      margin:0; padding:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ink);
      background: radial-gradient(1200px 800px at 20% -10%, var(--bg1), transparent),
                  radial-gradient(1200px 800px at 100% 20%, var(--bg2), transparent),
                  linear-gradient(180deg, #ffffff 0%, #f5f7ef 60%, #edf1e3 100%);
      background-attachment: fixed;
    }
    .wrap{max-width:960px; margin:0 auto; padding:32px 20px 64px}
    header{text-align:center;}
    .badge{display:inline-block; padding:6px 10px; font-size:12px; border-radius:999px; background:rgba(107,142,35,.08); color:#374619;}
    .title{font-family: "Playfair Display", serif; font-weight:700; font-size: clamp(28px, 6vw, 48px);}
    .subtitle{color:var(--muted); font-size:14px}

    .card{
      margin-top:22px; background:var(--card); border-radius:20px; padding:22px;
      box-shadow:0 10px 30px rgba(107,142,35,.08), 0 2px 12px rgba(0,0,0,.06);
      border:1px solid rgba(107,142,35,.08);
    }

    .grid{display:grid; grid-template-columns:1fr; gap:12px; margin-top:20px}
    @media(min-width:680px){.grid{grid-template-columns:1fr 1fr;}}

    .chapter{
      border:1px solid rgba(107,142,35,.12); background:#fff;
      border-radius:16px; padding:14px; display:flex; flex-direction:column; gap:8px;
      transition:.2s;
    }
    .chapter.playing{background:#38761D; color:#fff;}
    .chapter.done{background:#9caf88; color:#1a1a1a;}

    .row{display:flex; align-items:center; gap:12px;}
    .num{width:30px;height:30px;border-radius:999px;
      background:linear-gradient(180deg,#d6dec1,#a4b97f);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;font-size:14px;color:#2f3120;}
    .ctitle{font-weight:600;font-size:15px}

    audio{width:100%; accent-color:var(--accent);}

    .tick{position:absolute; top:10px; right:10px; font-size:12px; padding:4px 8px; border-radius:999px; background:rgba(34,197,94,.12); color:#166534; display:none;}
    .chapter.done .tick{display:inline-flex;}

    .footer{margin-top:30px;text-align:center;font-size:12px;color:var(--muted);}
    .footer a{color:#374619;text-decoration:none;}

    /* Commenti */
    .comment-box{margin-top:10px;padding:10px;border:1px solid #c2c7b0;border-radius:8px;background:#f4f4eb;}
    .comment-box textarea{width:100%;min-height:60px;border-radius:6px;border:1px solid #ccc;padding:6px;margin-bottom:6px;}
    .comment-box button{background:var(--accent);color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;}
    .comment-box button:hover{background:var(--accent-2);}
    .comments-list p{font-size:14px;margin:4px 0;padding:4px;background:#e6eed1;border-radius:4px;}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <span class="badge">‚ù§Ô∏è Andiamo</span>
      <h1 class="title">La canzone di Achille</h1>
      <p class="subtitle">Capitoli da ascoltare quando vuoi ‚ú®</p>
    </header>

    <section class="card hero">
      <p>Questo √® uno dei miei libri preferiti, e adoro fartelo conoscere cos√¨ üíå</p>
    </section>

    <section class="card">
      <div class="grid" id="chapters"></div>
    </section>

    <p class="footer">Con ‚ù§Ô∏è ‚Äî Per Margherita</p>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";
    import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-messaging.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDIJ7LyZMWfWxxZWNGVD1vSAfRDS0M2_P8",
      authDomain: "libroaudio-d36b5.firebaseapp.com",
      projectId: "libroaudio-d36b5",
      storageBucket: "libroaudio-d36b5.firebasestorage.app",
      messagingSenderId: "1047668815151",
      appId: "1:1047668815151:web:552fa4dd63b2a847845dda"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const messaging = getMessaging(app);

    // Notifiche
    async function initNotifications(){
      try{
        const permission = await Notification.requestPermission();
        if(permission==="granted"){
          const token = await getToken(messaging,{vapidKey:"LA-TUA-VAPID-KEY"});
          console.log("Token:", token);
        }
      }catch(e){console.error(e);}
    }
    initNotifications();
    onMessage(messaging, (payload)=>alert(`üìñ Nuovo capitolo: ${payload.notification.title}`));

    // Capitoli
    const chapters=[
      { title:"Capitolo 1", file:"01-Capitolo-1.mp3"},
      { title:"Capitolo 2", file:"02-Capitolo-2.mp3"},
      { title:"Capitolo 3", file:"03-Capitolo-3.mp3"},
      { title:"Capitolo 4", file:"04-Capitolo-4.mp3"},
      { title:"Capitolo 5", file:"05-Capitolo-5.mp3"},
      { title:"Capitolo 6", file:"06-Capitolo-6.mp3"},
      { title:"Capitolo 7", file:"07-Capitolo-7.mp3"},
    ];

    const grid=document.getElementById("chapters");
    const audios=[];
    const listenedKey=(f)=>`listened::${f}`;

    chapters.forEach((c,i)=>{
      const card=document.createElement("div");
      card.className="chapter";
      card.dataset.file=c.file;

      const top=document.createElement("div");
      top.className="row";
      const num=document.createElement("span");
      num.className="num"; num.textContent=(i+1).toString().padStart(2,"0");
      const t=document.createElement("div");
      t.className="ctitle"; t.textContent=c.title;
      top.appendChild(num); top.appendChild(t);
      card.appendChild(top);

      const audio=document.createElement("audio");
      audio.controls=true;
      const src=document.createElement("source");
      src.src=`audio/${c.file}`; src.type="audio/mpeg";
      audio.appendChild(src);
      card.appendChild(audio);
      audios.push(audio);

      audio.addEventListener("play",()=>{
        audios.forEach(a=>{
          if(a!==audio){
            a.pause();
            const cc=a.parentElement;
            cc.classList.remove("playing");
            if(localStorage.getItem(listenedKey(cc.dataset.file))==="1") cc.classList.add("done");
          }
        });
        card.classList.add("playing");
      });

      audio.addEventListener("ended",()=>{
        card.classList.remove("playing");
        localStorage.setItem(listenedKey(c.file),"1");
        card.classList.add("done");
      });

      if(localStorage.getItem(listenedKey(c.file))==="1") card.classList.add("done");

      // Download
      const dl=document.createElement("a");
      dl.href=`audio/${c.file}`; dl.download=c.file;
      dl.textContent="Scarica";
      dl.style.fontSize="13px";
      card.appendChild(dl);

      // Commenti
      const commentBox=document.createElement("div"); commentBox.className="comment-box";
      const ta=document.createElement("textarea"); ta.placeholder="Scrivi un pensiero...";
      const save=document.createElement("button"); save.textContent="Salva";
      const toggle=document.createElement("button"); toggle.textContent="Vedi commenti";
      toggle.style.marginLeft="6px"; toggle.style.background="#a4b97f"; toggle.style.color="#2f3120";
      const list=document.createElement("div"); list.className="comments-list"; list.style.display="none";

      toggle.addEventListener("click",()=>{
        if(list.style.display==="none"){list.style.display="block"; toggle.textContent="Nascondi commenti";}
        else{list.style.display="none"; toggle.textContent=list.childElementCount>0?`Vedi commenti (${list.childElementCount})`:"Vedi commenti";}
      });

      save.addEventListener("click",async()=>{
        if(ta.value.trim()!==""){
          await addDoc(collection(db,"commenti"),{capitolo:c.title,testo:ta.value,timestamp:new Date()});
          ta.value=""; loadComments(c.title);
        }
      });

      async function loadComments(c.title){
        list.innerHTML="";
        const q=query(collection(db,"commenti"),where("capitolo","==",c.title),orderBy("timestamp","asc"));
        const snap=await getDocs(q);
        snap.forEach(doc=>{
          const p=document.createElement("p");
          p.textContent="üí¨ "+doc.data().testo;
          list.appendChild(p);
        });
        toggle.textContent=list.childElementCount>0?`Vedi commenti (${list.childElementCount})`:"Vedi commenti";
      }
      loadComments(c.title);

      commentBox.appendChild(ta); commentBox.appendChild(save); commentBox.appendChild(toggle); commentBox.appendChild(list);
      card.appendChild(commentBox);

      grid.appendChild(card);
    });
    saveBtn.addEventListener('click', async () => {
  if(textarea.value.trim() !== ""){
    await addDoc(collection(window.db, "commenti"), {
      capitolo: c.title,
      testo: textarea.value,
      timestamp: new Date()
    });
    textarea.value = "";
    loadComments(c.title);
  }
});

async function loadComments(chapter){
  commentsList.innerHTML = "";
  const q = query(
    collection(window.db, "commenti"),
    where("capitolo","==", chapter),
    orderBy("timestamp","asc")
  );
  const snapshot = await getDocs(q);
  snapshot.forEach(doc => {
    const p = document.createElement('p');
    p.textContent = "üí¨ " + doc.data().testo;
    commentsList.appendChild(p);
  });
  toggleBtn.textContent = commentsList.childElementCount > 0
    ? `Vedi commenti (${commentsList.childElementCount})`
    : "Vedi commenti";
}

  </script>
</body>
</html>
