<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Per Margherita ‚Äî La canzone di Achille</title>
  <meta name="description" content="La canzone di Achille, Madeline Miller." />
  <meta property="og:title" content="Per Margherita ‚Äî La canzone di Achille" />
  <meta property="og:description" content="Audiolibro capitoli personalizzati" />
  <meta property="og:type" content="website" />

  <!-- Icona -->
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%E2%9D%A4%EF%B8%8F%3C/text%3E%3C/svg%3E">

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- Stili -->
  <style>
    :root{
      --bg1:#f4f4eb;
      --bg2:#e9eddb;
      --card:#ffffff;
      --ink:#2f3120;
      --muted:#6b705c;
      --accent:#6b8e23;
      --accent-2:#a4b97f;
    }
    body{
      margin:0; padding:0;
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ink);
      background: radial-gradient(1200px 800px at 20% -10%, var(--bg1), transparent),
                  radial-gradient(1200px 800px at 100% 20%, var(--bg2), transparent),
                  linear-gradient(180deg, #ffffff 0%, #f5f7ef 60%, #edf1e3 100%);
      background-attachment: fixed;
    }
    .wrap{max-width:960px; margin:0 auto; padding:32px 20px 64px}
    header{text-align:center;}
    .badge{display:inline-block; padding:6px 10px; font-size:12px; border-radius:999px; background:rgba(107,142,35,.08); color:#374619;}
    .title{font-family: "Playfair Display", serif; font-weight:700; font-size: clamp(28px, 6vw, 48px);}
    .subtitle{color:var(--muted); font-size:14px}

    .card{
      margin-top:22px; background:var(--card); border-radius:20px; padding:22px;
      box-shadow:0 10px 30px rgba(107,142,35,.08), 0 2px 12px rgba(0,0,0,.06);
      border:1px solid rgba(107,142,35,.08);
    }

    .grid{display:grid; grid-template-columns:1fr; gap:12px; margin-top:20px}
    @media(min-width:680px){.grid{grid-template-columns:1fr 1fr;}}

    .chapter{
      border:1px solid rgba(107,142,35,.12); background:#fff;
      border-radius:16px; padding:14px; display:flex; flex-direction:column; gap:8px;
      transition:.2s;
    }
    .chapter.playing{background:#38761D; color:#fff;}
    .chapter.done{background:#9caf88; color:#1a1a1a;}
    .chapter.started { background: #cfe3b4; color: #1a1a1a;}


    .row{display:flex; align-items:center; gap:12px;}
    .num{width:30px;height:30px;border-radius:999px;
      background:linear-gradient(180deg,#d6dec1,#a4b97f);
      display:flex;align-items:center;justify-content:center;
      font-weight:700;font-size:14px;color:#2f3120;}
    .ctitle{font-weight:600;font-size:15px}

    audio{width:100%; accent-color:var(--accent);}

    .tick{position:absolute; top:10px; right:10px; font-size:12px; padding:4px 8px; border-radius:999px; background:rgba(34,197,94,.12); color:#166534; display:none;}
    .chapter.done .tick{display:inline-flex;}

    .footer{margin-top:30px;text-align:center;font-size:12px;color:var(--muted);}
    .footer a{color:#374619;text-decoration:none;}

    /* Commenti */
    .comment-box{margin-top:10px;padding:10px;border:1px solid #c2c7b0;border-radius:8px;background:#f4f4eb;}
    .comment-box textarea{width:100%;min-height:60px;border-radius:6px;border:1px solid #ccc;padding:6px;margin-bottom:6px;}
    .comment-box button{background:var(--accent);color:#fff;border:none;padding:6px 12px;border-radius:6px;cursor:pointer;}
    .comment-box button:hover{background:var(--accent-2);}
    .comments-list p{font-size:14px;margin:4px 0;padding:4px;background:#e6eed1;border-radius:4px;}

    #timerButton {
      background-color: #556b2f;
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    #timerButton:hover { background-color: #6b8e23; }

    /* --- MENU LATERALE --- */
    .menu-btn {
      position: fixed;
      top: 16px;
      left: 16px;
      font-size: 28px;
      cursor: pointer;
      color: #556b2f;
      z-index: 1001;
      background: rgba(255,255,255,0.8);
      padding: 4px 10px;
      border-radius: 8px;
      transition: background 0.3s;
    }
    .menu-btn:hover { background: #e9eddb; }

    .side-menu {
      height: 100%;
      width: 0;
      position: fixed;
      z-index: 1002;
      top: 0;
      left: 0;
      background-color: #f4f4eb;
      overflow-x: hidden;
      transition: 0.3s;
      padding-top: 60px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.1);
    }
    .side-menu a {
      padding: 12px 24px;
      text-decoration: none;
      font-size: 18px;
      color: #374619;
      display: block;
      transition: background 0.2s;
    }
    .side-menu a:hover { background-color: #e6eed1; }
    .side-menu h2 {
      margin-left: 24px;
      font-size: 20px;
      color: #6b8e23;
    }
    .side-menu .close-btn {
      position: absolute;
      top: 12px;
      right: 20px;
      font-size: 32px;
      text-decoration: none;
      color: #6b8e23;
    }

    .overlay {
      position: fixed;
      display: none;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.3);
      z-index: 1000;
      transition: opacity 0.3s;
    }
    .overlay.show { display: block; }
  </style>
</head>
<body>

  <!-- MENU LATERALE -->
  <div id="menuBtn" class="menu-btn">‚ò∞</div>

  <nav id="sideMenu" class="side-menu">
    <a href="javascript:void(0)" class="close-btn">&times;</a>
    <h2>üìö Menu</h2>
    <a href="citazioni.html">üåø Le mie citazioni preferite</a>
  </nav>

  <div id="overlay" class="overlay"></div>

  <div class="wrap">
    <header>
      <span class="badge">‚ù§Ô∏è Andiamo</span>
      <h1 class="title">La canzone di Achille</h1>
      <p class="subtitle">Capitoli da ascoltare quando vuoi ‚ú®</p>
    </header>

    <section class="card hero">
      <p>Questo √® uno dei miei libri preferiti, e adoro fartelo conoscere cos√¨ üíå</p>
    </section>

    <section class="card">
      <div class="grid" id="chapters"></div>
    </section>

    <p class="footer">Con ‚ù§Ô∏è ‚Äî Per Margherita</p>
  </div>

  <!-- Firebase + Capitoli -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDIJ7LyZMWfWxxZWNGVD1vSAfRDS0M2_P8",
      authDomain: "libroaudio-d36b5.firebaseapp.com",
      projectId: "libroaudio-d36b5",
      storageBucket: "libroaudio-d36b5.firebasestorage.app",
      messagingSenderId: "1047668815151",
      appId: "1:1047668815151:web:552fa4dd63b2a847845dda"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const chapters = [
      { title: "Capitolo 1", file: "01-Capitolo-1.mp3" },
      { title: "Capitolo 2", file: "02-Capitolo-2.mp3" },
      { title: "Capitolo 3", file: "03-Capitolo-3.mp3" },
      { title: "Capitolo 4", file: "04-Capitolo-4.mp3" },
      { title: "Capitolo 5", file: "05-Capitolo-5.mp3" },
      { title: "Capitolo 6", file: "06-Capitolo-6.mp3" },
      { title: "Capitolo 7", file: "07-Capitolo-7.mp3" },
      { title: "Capitolo 8", file: "08-Capitolo-8.mp3" },
      { title: "Capitolo 9", file: "09-Capitolo-9.mp3" },
      { title: "Capitolo 10", file: ["10-Capitolo-10-parte-1.mp3", "10-Capitolo-10-parte-2.mp3"] }
    ];

    const grid = document.getElementById("chapters");
    const audios = [];
    const listenedKey = (f) => `listened::${f}`;

    async function loadCommentsFor(chapterTitle, commentsList, toggleBtn) {
      commentsList.innerHTML = "";
      try {
        const q = query(collection(db, "commenti"),
          where("capitolo", "==", chapterTitle),
          orderBy("timestamp", "asc")
        );
        const snap = await getDocs(q);
        snap.forEach(doc => {
          const p = document.createElement("p");
          p.textContent = "üí¨ " + doc.data().testo;
          commentsList.appendChild(p);
        });
      } catch (err) {
        console.error("Errore loadCommentsFor:", err);
        const p = document.createElement("p");
        p.textContent = "Errore caricamento commenti";
        commentsList.appendChild(p);
      }
      toggleBtn.textContent = commentsList.childElementCount > 0
        ? `Vedi commenti (${commentsList.childElementCount})`
        : "Vedi commenti";
    }

    chapters.forEach((c, i) => {
      const card = document.createElement("div");
      card.className = "chapter";
      card.dataset.file = c.file;

      const top = document.createElement("div");
      top.className = "row";
      const num = document.createElement("span");
      num.className = "num";
      num.textContent = (i + 1).toString().padStart(2, "0");
      const titleDiv = document.createElement("div");
      titleDiv.className = "ctitle";
      titleDiv.textContent = c.title;
      top.append(num, titleDiv);
      card.append(top);

     // gestisce uno o pi√π file audio
if (Array.isArray(c.file)) {
  c.file.forEach(f => {
    const audio = document.createElement("audio");
    audio.controls = true;
    audio.preload = "none";
    const source = document.createElement("source");
    source.src = `audio/${f}`;
    source.type = "audio/mpeg";
    audio.appendChild(source);
    card.appendChild(audio);
    audios.push(audio);
  });
} else {
  const audio = document.createElement("audio");
    audio.controls = true;
    audio.preload = "none";
    const source = document.createElement("source");
    source.src = `audio/${c.file}`;
    source.type = "audio/mpeg";
    audio.appendChild(source);
    card.appendChild(audio);
    audios.push(audio);
}


      // timer
      const timerDiv = document.createElement("div");
      timerDiv.style.marginTop = "10px";

      const timerButton = document.createElement("button");
      timerButton.textContent = "üïí Imposta timer";
      timerButton.style.background = "#556b2f";
      timerButton.style.color = "#fff";
      timerButton.style.border = "none";
      timerButton.style.padding = "6px 12px";
      timerButton.style.borderRadius = "8px";
      timerButton.style.cursor = "pointer";
      timerButton.style.marginRight = "10px";

      const timerStatus = document.createElement("span");
      timerStatus.style.fontSize = "13px";
      timerStatus.style.fontStyle = "italic";
      timerStatus.style.color = "#374619";

      timerDiv.appendChild(timerButton);
      timerDiv.appendChild(timerStatus);
      card.appendChild(timerDiv);

      let sleepTimer = null;
      let remainingSeconds = 0;

      timerButton.addEventListener("click", () => {
        const minutes = parseInt(prompt("Tra quanti minuti vuoi che l‚Äôaudio si fermi? (es. 5, 10, 15)"));
        if (isNaN(minutes) || minutes <= 0) {
          alert("Inserisci un numero valido di minuti!");
          return;
        }
        if (sleepTimer) clearInterval(sleepTimer);
        remainingSeconds = minutes * 60;
        updateTimerStatus();
        sleepTimer = setInterval(() => {
          remainingSeconds--;
          updateTimerStatus();
          if (remainingSeconds <= 0) {
            clearInterval(sleepTimer);
            audio.pause();
            timerStatus.textContent = "‚è∞ Timer terminato ‚Äì buona notte üí´";
          }
        }, 1000);
      });

      function updateTimerStatus() {
        const minutesLeft = Math.floor(remainingSeconds / 60);
        const secondsLeft = remainingSeconds % 60;
        timerStatus.textContent = `L‚Äôaudio si fermer√† tra ${minutesLeft}:${secondsLeft.toString().padStart(2,"0")}`;
      }

      // play / ended
      audio.addEventListener("play", () => {
        audios.forEach(a => {
          if (a !== audio) {
            a.pause();
            const otherCard = a.parentElement;
            otherCard.classList.remove("playing");
            if (localStorage.getItem(listenedKey(otherCard.dataset.file)) === "1") otherCard.classList.add("done");
          }
        });
        // Salva posizione ogni 5 secondi
audio.addEventListener("timeupdate", () => {
  if (!audio.paused) {
    localStorage.setItem(`pos::${c.file}`, audio.currentTime);
  }
});

// Riprendi la posizione salvata
const savedTime = localStorage.getItem(`pos::${c.file}`);
if (savedTime) {
  audio.currentTime = parseFloat(savedTime);
}

        card.classList.add("playing");
        localStorage.setItem(`started::${c.file}`, "1"); card.classList.add("started");

      });

      audio.addEventListener("ended", () => {
        card.classList.remove("playing");
        localStorage.setItem(listenedKey(c.file), "1");
        localStorage.removeItem(`pos::${c.file}`);
        card.classList.add("done");
      });

      if (localStorage.getItem(listenedKey(c.file)) === "1") card.classList.add("done");
      else if (localStorage.getItem(`started::${c.file}`) === "1") card.classList.add("started");


      // download
      const dl = document.createElement("a");
      dl.href = `audio/${c.file}`;
      dl.download = c.file;
      dl.textContent = "Scarica";
      dl.style.fontSize = "13px";
      card.appendChild(dl);

      // comment box
      const commentBox = document.createElement("div");
      commentBox.className = "comment-box";
      const textarea = document.createElement("textarea");
      textarea.placeholder = "Scrivi un pensiero su questo capitolo...";
      const saveBtn = document.createElement("button");
      saveBtn.textContent = "Salva";
      const toggleBtn = document.createElement("button");
      toggleBtn.textContent = "Vedi commenti";
      toggleBtn.style.marginLeft = "6px";
      toggleBtn.style.background = "#a4b97f";
      toggleBtn.style.color = "#2f3120";
      const commentsList = document.createElement("div");
      commentsList.className = "comments-list";
      commentsList.style.display = "none";

      toggleBtn.addEventListener("click", () => {
        if (commentsList.style.display === "none") {
          commentsList.style.display = "block";
          toggleBtn.textContent = "Nascondi commenti";
        } else {
          commentsList.style.display = "none";
          toggleBtn.textContent = commentsList.childElementCount > 0
            ? `Vedi commenti (${commentsList.childElementCount})`
            : "Vedi commenti";
        }
      });

      saveBtn.addEventListener("click", async () => {
        if (textarea.value.trim() === "") return;
        try {
          await addDoc(collection(db, "commenti"), {
            capitolo: c.title,
            testo: textarea.value,
            timestamp: new Date()
          });
          textarea.value = "";
          await loadCommentsFor(c.title, commentsList, toggleBtn);
          commentsList.style.display = "block";
          toggleBtn.textContent = "Nascondi commenti";
        } catch (err) {
          console.error("Errore salvataggio commento:", err);
        }
      });

      loadCommentsFor(c.title, commentsList, toggleBtn);
      commentBox.append(textarea, saveBtn, toggleBtn, commentsList);
      card.appendChild(commentBox);

      grid.appendChild(card);
    });

  </script>

  <!-- Menu laterale script -->
  <script>
    const menuBtn = document.getElementById("menuBtn");
    const sideMenu = document.getElementById("sideMenu");
    const overlay = document.getElementById("overlay");
    const closeBtn = sideMenu.querySelector(".close-btn");

    menuBtn.addEventListener("click", () => {
      sideMenu.style.width = "250px";
      overlay.classList.add("show");
    });

    closeBtn.addEventListener("click", () => {
      sideMenu.style.width = "0";
      overlay.classList.remove("show");
    });

    overlay.addEventListener("click", () => {
      sideMenu.style.width = "0";
      overlay.classList.remove("show");
    });
  </script>

</body>
</html>
